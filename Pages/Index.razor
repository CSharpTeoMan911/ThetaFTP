@using System.Net.Http.Headers
@using ThetaFTP.Pages.Components;
@using ThetaFTP.Shared.Formatters;
@using ThetaFTP.Shared.Classes;
@using System.Text;
@using ThetaFTP.Shared.Models;
@inject NavigationManager NavigationManager;
@inject IJSRuntime JS;
@page "/"


<PanelComponent>
    <Component>
        <div class="files_panel">
            <div class="files_panel_control ">
                <div style="display:inline-block; width:100%;">
                    <div class="panel_control_section">
                        <div class="files_panel_file_options">
                            <button class="control_button" style="margin-left: 20px" onclick="document.getElementById('file_dialog').click()">
                                <img class="control_image" src="./images/cloud-computing.webp" />
                                <InputFile id="file_dialog" OnChange="@Upload" hidden/>
                            </button>
                            <button class="control_button" style="margin-left: 40px" @onclick=CreateFolder>
                                <img class="control_image" src="./images/new-folder.webp" />
                            </button>
                        </div>
                    </div>

                    <div class="panel_control_section">
                        <div class="files_panel_file_search">
                            <div class="files_panel_file_search_control">
                                <input style="margin-left: 20px"  placeholder="Search" />
                                <button class="control_button" @onclick=Search>
                                    <img class="control_image" src="./images/search.webp" />
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
           </div>
            <div class="path_display">
                <p class="path_label">
                    Path
                </p>
                <input class="path_input" />
            </div>
        </div>
    </Component>
</PanelComponent>


@code{
    private string Path { get; set; } = "/";


    public async void Upload(InputFileChangeEventArgs e)
    {
        try
        {
            IJSObjectReference module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/functions.js");
            string log_in_session_key = await module.InvokeAsync<string>("Get_Cache", "auth", "AuthCache");


            Tuple<string, Stream, StreamContent?> payload =  await FileUploadPayloadBuilder.FileUpload(e.File, Path, log_in_session_key);

            if (payload.Item3 != null)
            {
                try
                {
                    HttpClient client = HttpClientGen.Generate();
                    client.BaseAddress = new Uri(NavigationManager.BaseUri);

                    HttpResponseMessage responseMessage = await client.PostAsync(payload.Item1, payload.Item3);

                    Console.WriteLine(await responseMessage.Content.ReadAsStringAsync());
                }
                finally
                {
                    await payload.Item2.DisposeAsync();
                }
            }
            else
            {
            }

        }
        catch{}
    }

    public void CreateFolder()
    {

    }

    public void Search()
    {
        
    }
}